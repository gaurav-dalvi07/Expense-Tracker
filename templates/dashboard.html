<!DOCTYPE html>
<html lang="en">
<head>
<title>Dashboard</title>

<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- PDF LIBRARIES -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>

/* ===== THEME ===== */
body.dark{background:#121212;color:white;}
.dark .card{background:#1e1e1e;color:white;}
.dark .table{color:white;}
.dark .table-dark{--bs-table-bg:#000;}
.dark .list-group-item{background:#222;color:white;}
.dark .alert{background:#333;border:none;}
.dark .budget-box{background:#222;color:white;}
.dark .welcome-box{background:linear-gradient(45deg,#444,#111);}
.dark .btn-outline-warning{color:white;border-color:white}

/* ===== WELCOME ===== */
.welcome-box{
background: linear-gradient(45deg,#00c6ff,#0072ff);
color:white;padding:12px;border-radius:12px;
margin-bottom:15px;text-align:center;font-weight:bold;
animation: fadein .6s;
}

@keyframes fadein{
from{opacity:0;transform:translateY(-10px);}
to{opacity:1;}
}

/* ===== BUDGET ===== */
.budget-box{
background:#f8f9fa;border-left:6px solid #0d6efd;
padding:12px;border-radius:8px;margin-bottom:15px;
}

.budget-alert{
background:#ffe5e5;border-left:6px solid red;
padding:12px;border-radius:8px;margin-bottom:15px;
font-weight:bold;color:red;text-align:center;
}

/* ===== CHART ===== */
.chart-box{
width:240px;
height:240px;
margin:auto;
}

</style>
</head>

<body class="bg-light">

<div class="container mt-4" id="pdfArea">

<!-- âœ… WELCOME -->
{% if welcome %}
<div class="welcome-box">
ğŸ‘‹ Welcome back, <b>{{ username }}</b> | Track your money ğŸ’°
</div>
{% endif %}

<!-- âœ… FLASH -->
{% with messages = get_flashed_messages(with_categories=true) %}
{% for cat,msg in messages %}
<div class="alert alert-{{ cat }}">{{ msg }}</div>
{% endfor %}
{% endwith %}

<!-- âœ… BUDGET WARNING -->
{% if budget_alert %}
<div class="budget-alert">
ğŸš¨ Budget Exceeded â€” â‚¹{{ total }} / â‚¹{{ budget }}
</div>
{% endif %}

<!-- âœ… SET BUDGET -->
<div class="budget-box">
<form onsubmit="saveBudget();return false;">
<b>ğŸ’° Monthly Budget:</b>
<input type="number" id="budgetInput" class="form-control d-inline w-25 ms-2" placeholder="Amount" required>
<button class="btn btn-primary btn-sm ms-2">Save</button>

{% if budget %}
<span class="ms-3 text-success">Current Budget â‚¹ {{ budget }}</span>
{% endif %}
</form>
</div>

<!-- âœ… TOP BAR -->
<div class="d-flex justify-content-between mb-3 align-items-center flex-wrap">
<h4>ğŸ“Š Expense Dashboard</h4>

<div class="btn-group mt-2">
<button onclick="toggleTheme()" class="btn btn-dark">ğŸŒ™ / â˜€</button>
<button onclick="exportPDF()" class="btn btn-info text-white">ğŸ“„ PDF</button>
<a href="/add" class="btn btn-success">â• Add</a>

<select id="monthSelect" class="btn btn-outline-warning" onchange="filterMonth()">
<option value="">Last 30 Days</option>
{% for m in monthly_totals.keys() %}
<option value="{{ m }}" {% if selected_month==m %}selected{% endif %}>{{ m }}</option>
{% endfor %}
</select>

<button id="monthClear" class="btn btn-warning text-white">ğŸ—‘ Month</button>
<button id="allClear" class="btn btn-danger">ğŸ”¥ All</button>
<a href="/logout" class="btn btn-secondary">Logout</a>
</div>
</div>

<!-- âœ… TOTAL -->
<div class="card p-3 shadow mb-3 text-center">
<h6>{% if selected_month %}Total {{ selected_month }}{% else %}Last 30 Days{% endif %}</h6>
<h3 class="text-success">â‚¹ {{ "%.2f"|format(total) }}</h3>
</div>

<!-- âœ… CATEGORY -->
<div class="card p-3 shadow mb-3">
<h6>Category Wise</h6>
{% if category_amounts %}
<ul class="list-group">
{% for cat,amt in category_amounts.items() %}
<li class="list-group-item d-flex justify-content-between">
{{ cat }} <b>â‚¹ {{ "%.2f"|format(amt) }}</b>
</li>
{% endfor %}
</ul>
{% else %}
No Data
{% endif %}
</div>

<!-- âœ… MONTH SUMMARY -->
<div class="card p-3 shadow mb-3">
<h6>Month Summary</h6>
<ul class="list-group">
{% for m,a in monthly_totals.items() %}
<li class="list-group-item d-flex justify-content-between">
{{ m }} <b>â‚¹ {{ "%.2f"|format(a) }}</b>
</li>
{% endfor %}
</ul>
</div>

<!-- âœ… EXPENSE TABLE -->
<div class="card p-3 shadow mb-3 table-responsive">
<h6>Expenses</h6>
<table class="table table-bordered table-hover">
<tr class="table-dark">
<th>Amount</th><th>Category</th><th>Date</th><th>Action</th>
</tr>
{% for e in expenses %}
<tr>
<td>â‚¹{{ "%.2f"|format(e["amount"]) }}</td>
<td>{{ e["category"] }}</td>
<td>{{ e["date"] }}</td>
<td>
<a class="btn btn-warning btn-sm" href="/edit/{{ e['id'] }}">âœ</a>
<a class="btn btn-danger btn-sm" href="/delete/{{ e['id'] }}" onclick="return confirm('Delete expense?')">ğŸ—‘</a>
</td>
</tr>
{% endfor %}
</table>
</div>

<!-- âœ… PIE -->
<div class="card p-3 shadow text-center mb-4">
<h6>Category Chart</h6>
{% if category_amounts %}
<div class="chart-box">
<canvas id="pieChart"></canvas>
</div>
{% endif %}
</div>

</div>

<!-- âœ… SCRIPT -->
<script>

/* THEME */
function toggleTheme(){
document.body.classList.toggle("dark");
localStorage.setItem("theme",document.body.classList.contains("dark")?"dark":"light");
}
if(localStorage.getItem("theme")=="dark")document.body.classList.add("dark");

/* MONTH FILTER */
function filterMonth(){
let m = monthSelect.value;
location = m ? "/dashboard?month="+m : "/dashboard";
}

/* PIE */
const labels = JSON.parse('{{ category_amounts.keys()|list|tojson|safe }}');
const data = JSON.parse('{{ category_amounts.values()|list|tojson|safe }}');

if(data.length){
new Chart(pieChart,{
type:"pie",
data:{labels:labels,datasets:[{data:data}]},
options:{
responsive:true,
maintainAspectRatio:false,
plugins:{legend:{position:'bottom'}}
}
});
}

/* CLEAR */
monthClear.onclick=()=>{
let m=monthSelect.value;
if(!m)return alert("Select month");
if(confirm("Delete "+m+" ?"))
fetch("/clear_month",{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify({month:m})})
.then(()=>location.reload());
}

allClear.onclick=()=>{
if(confirm("Delete ALL?"))
fetch("/clear_all",{method:"POST"}).then(()=>location.reload());
}

/* SAVE BUDGET */
function saveBudget(){
let amt=budgetInput.value;
let m=monthSelect.value || new Date().toISOString().slice(0,7);
fetch("/set_budget",{method:"POST",headers:{'Content-Type':'application/json'},
body:JSON.stringify({month:m,amount:amt})}).then(()=>location.reload());
}

/* AUTO HIDE FLASH */
setTimeout(()=>{
document.querySelectorAll('.alert,.welcome-box,.budget-alert').forEach(e=>{
e.style.opacity=0;
setTimeout(()=>e.remove(),500);
});
},3000)

/* PDF EXPORT */
async function exportPDF(){
const { jsPDF } = window.jspdf;
const area = document.getElementById("pdfArea");

const canvas = await html2canvas(area,{scale:2});
const img = canvas.toDataURL("image/png");

const pdf = new jsPDF("p","mm","a4");
const w = 210;
const h = canvas.height * w / canvas.width;

pdf.addImage(img,"PNG",0,0,w,h);
pdf.save("Expense_Report.pdf");
}

</script>
</body>
</html>
